import random
import math

def is_prime(n, k=40):
    if n <= 1:
        return False
    if n <= 3:
        return True
    if n % 2 == 0:
        return False

    d = n - 1
    r = 0
    while d % 2 == 0:
        d //= 2
        r += 1

    for _ in range(k):
        a = random.randrange(2, n - 1)
        x = pow(a, d, n)

        if x == 1 or x == n - 1:
            continue

        is_composite = True
        for _ in range(r - 1):
            x = pow(x, 2, n)
            if x == n - 1:
                is_composite = False
                break
        
        if is_composite:
            return False

    return True

def generate_prime(bits):
    while True:
        p = random.randrange(2**(bits-1), 2**bits)
        if p % 2 == 0:
            p += 1
        
        if is_prime(p):
            return p

def get_prime_factors(n):
    factors = set()
    d = 2
    temp_n = n
    while d * d <= temp_n:
        if temp_n % d == 0:
            factors.add(d)
            while temp_n % d == 0:
                temp_n //= d
        d += 1
    if temp_n > 1:
        factors.add(temp_n)
    return factors

def is_primitive_root(g, p):
    if not (1 <= g < p):
        return False

    phi = p - 1
    prime_factors_phi = get_prime_factors(phi)

    for q in prime_factors_phi:
        if pow(g, phi // q, p) == 1:
            return False
            
    return True

def find_primitive_root(p):
    for g in range(2, p):
        if is_primitive_root(g, p):
            return g
    return None

def main():
    PRIME_BITS = 16 
    P = generate_prime(PRIME_BITS)
    print("The value of P (generated prime):", P)
    
    G = find_primitive_root(P)
    if G is None:
        print(f"Could not find a generator for P={P}")
        return
        
    print("The value of G (found generator):", G)
    
    a = random.randint(2, P - 2)
    print("The private key a for Alice:", a)
    
    b = random.randint(2, P - 2)
    print("The private key b for Bob:", b)
    
    x = pow(G, a, P)
    y = pow(G, b, P)
    
    ka = pow(y, a, P)
    kb = pow(x, b, P)

    print("Secret key for Alice is:", ka)
    print("Secret key for Bob is:", kb)

    assert ka == kb

if __name__ == "__main__":
    main()